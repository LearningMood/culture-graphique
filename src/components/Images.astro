---
// ============================================
// Images.astro - Grille d'images avec lightbox
// ============================================

export interface Props {
  src?: string | string[];
  alt?: string | string[];
  caption?: string | string[];
  folder?: string;
  cols?: 1 | 2 | 3;
  width?: 'narrow' | 'medium' | 'wide' | 'full';
  ratio?: string;
  fit?: 'cover' | 'contain';
  clickable?: boolean;
}

const { 
  src,
  alt = '',
  caption,
  folder = '',
  cols = 1, 
  width = 'wide', 
  ratio = null, 
  fit = 'cover',
  clickable = true
} = Astro.props;

// Classes utilitaires
const widthClass = {
  narrow: 'col-narrow',
  medium: 'col-medium',
  wide: 'col-wide',
  full: 'col-full'
}[width];

const colClass = `${widthClass} ${cols > 1 ? `images-${cols}` : ''}`.trim();

// Normaliser en tableaux
const sources = Array.isArray(src) ? src : src ? [src] : [];
const alts = Array.isArray(alt) ? alt : [alt];
const captions = caption ? (Array.isArray(caption) ? caption : [caption]) : [];

// Construire le chemin complet
const getFullPath = (path: string) => {
  if (path.startsWith('/')) return path;
  return `${folder}${path}`;
};
---

<div class={`images ${colClass}`} style={`--ratio: ${ratio}; --fit: ${fit}`}>
  {sources.map((imgSrc, i) => {
    const fullPath = getFullPath(imgSrc);
    const altText = alts[i] || alts[0] || '';
    const captionText = captions[i] || (i === 0 && captions[0]) || null;
    
    return (
      <figure>
        {clickable ? (
          <a href={fullPath} class="image-lightbox" data-alt={altText}>
            <img src={fullPath} alt={altText} />
          </a>
        ) : (
          <img src={fullPath} alt={altText} />
        )}
        {captionText && <figcaption>{captionText}</figcaption>}
      </figure>
    );
  })}
</div>

<style>
  .image-lightbox {
    display: block;
    cursor: zoom-in;
  }
  
  .image-lightbox:hover {
    opacity: 0.9;
  }
</style>

<script>
  document.addEventListener('click', (e) => {
    const link = (e.target as HTMLElement).closest('.image-lightbox');
    if (!link) return;
    
    e.preventDefault();
    
    const href = link.getAttribute('href');
    const alt = link.getAttribute('data-alt') || '';
    
    // Créer la lightbox
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox-overlay';
    lightbox.innerHTML = `
      <div class="lightbox-content">
        <button class="lightbox-close" aria-label="Fermer">&times;</button>
        <img src="${href}" alt="${alt}" />
      </div>
    `;
    
    document.body.appendChild(lightbox);
    document.body.style.overflow = 'hidden';
    
    // Fermer au clic ou Échap
    const close = () => {
      lightbox.remove();
      document.body.style.overflow = '';
      document.removeEventListener('keydown', closeOnEscape);
    };
    
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox || (e.target as HTMLElement).classList.contains('lightbox-close')) {
        close();
      }
    });
    
    const closeOnEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') close();
    };
    document.addEventListener('keydown', closeOnEscape);
  });
</script>
