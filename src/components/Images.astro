---
// ============================================
// Images.astro - Grille d'images
// ============================================

export interface Props {
  src?: string | string[];     // un ou plusieurs chemins d'images
  alt?: string | string[];     // texte(s) alternatif(s)
  caption?: string | string[]; // légende(s) optionnelle(s)
  folder?: string;           // chemin de base (ex: "/ux-design/lois-theories-ergonomie/")
  cols?: 1 | 2 | 3;
  width?: 'narrow' | 'medium' | 'wide' | 'full';
  ratio?: string;
  fit?: 'cover' | 'contain';
  clickable?: boolean;         // rendre les images cliquables (défaut: true)
}

const { 
  src,
  alt = '',
  caption,
  folder = '',
  cols = 1, 
  width = 'medium', 
  ratio = null, 
  fit = 'cover',
  clickable = true         // rendre les images cliquables (défaut: true)
} = Astro.props;

// Classes utilitaires
const widthClass = {
  narrow: 'col-narrow',
  medium: 'col-medium',
  wide: 'col-wide',
  full: 'col-full'
}[width];

// Pour cumuler les classes si col-2 ou 3
const colClass = `${widthClass} ${cols > 1 ? `images-${cols}` : ''}`.trim();

// Normaliser en tableaux
const sources = Array.isArray(src) ? src : src ? [src] : [];
const alts = Array.isArray(alt) ? alt : [alt];
const captions = caption ? (Array.isArray(caption) ? caption : [caption]) : [];

const normalizeBase = (s: string) => {
  if (!s) return '';
  const start = s.startsWith('/') ? s : `/${s}`;
  return start.endsWith('/') ? start : `${start}/`;
};

const base = normalizeBase(folder);
// Fonction helper pour construire le chemin complet
const getFullPath = (path: string) => {
  // Si déjà absolu (/...), on garde tel quel
  if (path.startsWith('/')) return path;
  // Sinon on préfixe avec le base normalisé
  return `${base}${path}`;
};


// Modèle Mdx
// <Images cols={2} width="wide" fit="contain"
//   src={[
//     "hick-larochelle-menu-light.jpg",
//     "hick-larochelle-menu-full.jpg"
//   ]}
//   alt={[
//     "Menu La Rochelle version light",
//     "Menu La Rochelle version complète"
//   ]}
//   caption={[
//     "Version simplifiée",
//     "Version complète"
//   ]}
// />
---

<div class={`images ${colClass}`} style={`--ratio: ${ratio}; --fit: ${fit}`}>
  {sources.map((imgSrc, i) => (
    <figure>
      { clickable ? ( 
        <a href={getFullPath(imgSrc)} class="image-lightbox" data-alt={alts[i] || alts[0] || ''}>
          <img src={getFullPath(imgSrc)} 
          alt={alts[i] || alts[0] || ''} 
          />
        </a>
      ) : ( 
        <img src={getFullPath(imgSrc)} 
          alt={alts[i] || alts[0] || ''} 
        />
      )}

      {captions[i] && <figcaption>{captions[i]}</figcaption>}
    </figure>
  ))}
</div>

<script>
  document.addEventListener('click', (e) => {
    const link = (e.target as HTMLElement).closest('.image-lightbox');
    if (!link) return;
    
    e.preventDefault();
    
    const href = link.getAttribute('href');
    const alt = link.getAttribute('data-alt') || '';
    
    // Créer la lightbox
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox-overlay';
    lightbox.innerHTML = `
      <div class="lightbox-content">
        <button class="lightbox-close" aria-label="Fermer">&times;</button>
        <img src="${href}" alt="${alt}" />
      </div>
    `;
    
    document.body.appendChild(lightbox);
    document.body.style.overflow = 'hidden';
    
    // Fermer au clic
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox || (e.target as HTMLElement).classList.contains('lightbox-close')) {
        lightbox.remove();
        document.body.style.overflow = '';
      }
    });
    
    // Fermer avec Échap
    const closeOnEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        lightbox.remove();
        document.body.style.overflow = '';
        document.removeEventListener('keydown', closeOnEscape);
      }
    };
    document.addEventListener('keydown', closeOnEscape);
  });
</script>