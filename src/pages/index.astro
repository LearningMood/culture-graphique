---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const all = await getCollection("formations");
const meta = await getCollection("formationsMeta");

const byFormation = all.reduce((acc, e) => {
  const formation = e.id.split('/')[0];
  (acc[formation] ||= []).push(e);
  return acc;
}, {} as Record<string, typeof all>);

const cards = meta.map(m => {
  const formation = m.data.formation;
  const entries = (byFormation[formation] || []).sort((a,b) =>
    (a.data.ordre ?? 99) - (b.data.ordre ?? 99)
  );

  let modules = entries.slice(0,3);
  if (m.data.chapitres_mis_en_avant?.length) {
    const set = new Set(m.data.chapitres_mis_en_avant);
    modules = entries.filter(e => set.has(e.slug)).slice(0,3);
  }

  return {
    url: `/formations/${formation}/`,
    titre: m.data.titre,
    couverture: m.data.couverture,
    resume: m.data.resume,
    modules
  };
});
---

<Base title="Toutes les formations">
  <main class="catalogue-formations">
    <div class="container">
        <h1>Toutes les formations</h1>

        <ul class="catalogue-grid">
        {cards.map(c => (
            <li class="formation-card">
            <a class="cover" href={c.url}>
                <img src={c.couverture} alt={`Couverture ${c.titre}`} loading="lazy" />
            </a>
            <h2><a href={c.url}>{c.titre}</a></h2>
            {c.resume && <p class="teaser">{c.resume}</p>}
            <ul class="chapters">
                {c.modules.map(m => (
                <li><a href={`${c.url}${m.slug}/`}>{m.data.titre}</a></li>
                ))}
            </ul>
            </li>
        ))}
        </ul>
    </div>
  </main>
</Base>
<style>

.catalogue-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:2rem; list-style: none;}
.formation-card{background:#fff;border-radius:4px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:1rem}
.cover img{width:100%;height:380px;object-fit:cover;border-radius:4px; margin-bottom: 2rem;}
.chapters{margin:.75rem 0 0;padding:0 1rem;list-style:disc}
</style>