---
// PAGE NOTION CHAPITRE
import { getCollection } from "astro:content";
import Base from "@/layouts/Base.astro";
import Formation from "@/layouts/Formation.astro";
import ImagesWithContext from "@/components/ImagesWithContext.astro";
import Note from '@/components/Note.astro';
import Exercice from "@/components/Exercice.astro";
import Section from '@components/Section.astro';
import Bandeau from '@components/Bandeau.astro';
import Texte from '@components/Texte.astro';
import Carousel from '@components/Carousel.astro';
import Ressources from "@/components/Ressources.astro";
import ChapitreFooter from "@/components/ChapitreFooter.astro";
import Citation from "@/components/Citation.astro";
import Synthese from "@/components/Synthese.astro";

export async function getStaticPaths() {
  const entries = await getCollection("formations");
  return entries.map((entry) => {
    const [formation] = entry.id.split("/");
    // entry.slug contient déjà le nom du fichier sans extension
    const slug = entry.slug.split("/").pop(); // Prend la dernière partie

    return {
      params: { formation, slug },
      props: { entry, formation },
    };
  });
}
const { entry, formation } = Astro.props;
const homeUrl = `/formations/${formation}/`; // ← URL de la home de la formation

// Récupérer meta pour le nom de la formation
const allMeta = await getCollection("formationsMeta");
const meta = allMeta.find(m => m.data.slug === formation);

// Récupérer tous les chapitres pour navigation
const allChapitres = await getCollection("formations");
const chapitres = allChapitres
  .filter(e => e.id.startsWith(`${formation}/`))
  .sort((a,b) => (a.data.jour ?? 99) - (b.data.jour ?? 99) || (a.data.ordre ?? 0) - (b.data.ordre ?? 0));

const currentIndex = chapitres.findIndex(c => c.slug === entry.slug);
const prevChapitre = currentIndex > 0 ? {
  url: `/formations/${formation}/${chapitres[currentIndex - 1].slug.split("/").pop()}/`,
  titre: chapitres[currentIndex - 1].data.titre
} : undefined;
const nextChapitre = currentIndex < chapitres.length - 1 ? {
  url: `/formations/${formation}/${chapitres[currentIndex + 1].slug.split("/").pop()}/`,
  titre: chapitres[currentIndex + 1].data.titre
} : undefined;


const { Content, headings } = await entry.render();
// console.log('headings:', headings);

// garde uniquement les H2
const headingsNiv2 = headings.filter((h) => Number(h.depth) === 2);
const pageTitle = `${entry.data.titre} — ${formation.replace(/-/g, " ")}`; // ← Utilisez formation

// Injecter le contexte
const imagePath = entry.data.folder || `/${formation}/`;
Astro.locals = Astro.locals || {};
Astro.locals.imageContext = { folder: imagePath };

---

<Base title={pageTitle} homeUrl={homeUrl}>
  <Formation entry={entry} headings={headingsNiv2} formation={formation}>
    <Content components={{ 
      Bandeau: Bandeau,
      Section: Section,
      Texte: Texte,
      Carousel: Carousel,
      Images: ImagesWithContext,
      Citation: Citation,
      Note: Note,
      Exercice: Exercice,
      Synthese: Synthese
    }} />
    <!-- Section Ressources -->
    {entry.data.ressources && entry.data.ressources.length > 0 && (
      <Ressources ressources={entry.data.ressources} />
    )}

  </Formation>
  <!-- Footer avec navigation -->
  <ChapitreFooter 
    formationUrl={`/formations/${formation}/`}
    formationNom={meta?.data.nom || formation.replace(/-/g, ' ')}
    prevChapitre={prevChapitre}
    nextChapitre={nextChapitre}
  />
</Base>

