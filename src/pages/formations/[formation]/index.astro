---
// HOME D'UNE FORMATION EN PARTICULIER
import { getCollection } from "astro:content";
import Base from "@/layouts/Base.astro";
import ChapitreCard from "@/components/ChapitreCard.astro";

export async function getStaticPaths() {
  const entries = await getCollection("formations");
  const formations = Array.from(new Set(entries.map(e => e.id.split("/")[0])));
  return formations.map((formation) => ({ 
    params: { formation }
  }));
}

const { formation } = Astro.params;
const homeUrl = `/formations/${formation}/`;

// Récupérer les métadonnées
const allMeta = await getCollection("formationsMeta");
const meta = allMeta.find(m => m.data.slug === formation);

// Récupérer les chapitres
const all = await getCollection("formations");
const entries = all.filter(e => e.id.startsWith(`${formation}/`))
  .sort((a,b) => (a.data.jour ?? 99) - (b.data.jour ?? 99) || (a.data.ordre ?? 0) - (b.data.ordre ?? 0));

  // ✅ Extraire les headings de niveau 2 pour chaque chapitre
const entriesAvecHeadings = await Promise.all(
  entries.map(async (entry) => {
    const { headings } = await entry.render();
    const h2 = headings
      .filter(h => h.depth === 2)
      .map(h => h.text);
    return { ...entry, h2Titles: h2 };
  })
);


// Grouper les chapitres par jour
const chapitresParJour = meta?.data.jours.map(jourInfo => ({
  ...jourInfo,
  chapitres: entriesAvecHeadings.filter(e => e.data.jour === jourInfo.num)
})) || [];
---

<Base title={`Formation — ${meta?.data.nom || formation.replace(/-/g,' ')}`} homeUrl={homeUrl}>
  <div class="home">
    <header class="home__hero">
      <h1>{meta?.data.nom || formation.replace(/-/g,' ')}</h1>
      <p class="baseline">{meta?.data.resume || ''}</p>
    </header>
    
    <main id="programme">
      {chapitresParJour.map((jour, index) => (
        jour.chapitres.length > 0 && (
          <section id={`jour${jour.num}`} class="container--maxi">
            <div class="home__programme">
              {index === 0 && <h4 class="home__programme__label">Le programme</h4>}
              <h5 class="info-jour">Jour {jour.num}</h5>
              <h2 class="home__programme__titre">{jour.titre}</h2>
              
              {/* {jour.themes && jour.themes.length > 0 && (
                <ul class="themes">
                  {jour.themes.map(t => <li>{t}</li>)}
                </ul>
              )} */}
            </div>

            {jour.chapitres.map((entry) => {
              // Extraire uniquement le nom du fichier (dernière partie du slug)
              const chapitreSlug = entry.slug.split("/").pop();
              
              return (
                <ChapitreCard
                  href={`/formations/${formation}/${chapitreSlug}/`}
                  miniature={entry.data.miniature ?? entry.data.headerImage} // ternaire
                  titre={entry.data.titre}
                  points={entry.h2Titles.length > 0 ? entry.h2Titles : entry.data.points_cles}
                  exercices={entry.data.exercices}
                />
              );
            })}
          </section>
        )
      ))}
    </main>
  </div>
</Base>

<style>
  .themes {
    list-style: disc;
    padding-left: 1.5rem;
    margin: 1rem 0;
    color: #666;
  }
  
  .themes li {
    margin: 0.25rem 0;
  }
</style>